<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.petnote.api.pet.mapper.PetMapper">

    <select id="selectList" resultType="com.petnote.api.pet.dto.PetDTO" >
        /* PetMapper.selectList 펫리스트 조회 */
        SELECT p.pet_no
            , p.pet_name
            , p.gender
            , p.species_type
            , c.kor_name AS species_name
            , p.breed_type
            , c2.kor_name AS breed_name
            , p.breed
            , img.file_path AS profile_img
        FROM PN_PET p
        LEFT OUTER JOIN PN_CODE c
            ON c.code_group1 = 'BREED_TYPE'
            AND c.code_group2 = 'SPECIES'
            AND c.code = p.species_type
        LEFT OUTER JOIN PN_CODE c2
            ON c2.code_group1 = 'BREED_TYPE'
            AND c2.code_group2 = p.species_type
            AND c2.code = p.breed_type
        LEFT OUTER JOIN PN_PET_IMG img
            ON img.pet_no = p.pet_no
            AND img.main_yn = 'Y'
        WHERE p.user_id = #{userId}
            AND p.use_yn = 'Y'
        ORDER BY FIELD(p.main_yn, 'Y') DESC, p.insert_date
    </select>

    <select id="selectPet" resultType="com.petnote.api.pet.dto.PetDTO" >
        /* PetMapper.selectPet 펫정보 조회 */
        SELECT p.pet_no
             , p.pet_name
             , p.birth
             , p.birth_know_yn
             , ROUND((TO_DAYS(NOW()) - (TO_DAYS(birth))) / 365) AS age
             , p.gender
             , p.neutrification_yn
             , p.species_type
             , c.kor_name AS species_name
             , p.breed_type
             , c2.kor_name AS breed_name
             , p.breed
             , p.remark
             , p.body_length
             , p.main_yn
             , img.file_path AS profile_img
             , p.pet_info
        FROM PN_PET p
        LEFT OUTER JOIN PN_CODE c
            ON c.code_group1 = 'BREED_TYPE'
            AND c.code_group2 = 'SPECIES'
            AND c.code = p.species_type
        LEFT OUTER JOIN PN_CODE c2
            ON c2.code_group1 = 'BREED_TYPE'
            AND c2.code_group2 = p.species_type
            AND c2.code = p.breed_type
        LEFT OUTER JOIN PN_PET_IMG img
            ON img.pet_no = p.pet_no
            AND img.main_yn = 'Y'
        WHERE p.user_id = #{userId} AND p.pet_no = #{petNo}
    </select>

    <insert id="insertPet" parameterType="com.petnote.api.pet.dto.PetDTO">
        /* PetMapper.insertPet 펫 등록 */
        <selectKey keyProperty="petNo" resultType="int" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>

        INSERT INTO PN_PET
        (
              user_id
            , pet_name
            , birth
            , birth_know_yn
            , gender
            , neutrification_yn
            , species_type
            , breed_type
            , breed
            , remark
            , use_yn
            , body_length
            , main_yn
            , pet_info
            , insert_date
            , update_date
        )
        VALUES
        (
              #{userId}
            , #{petName}
            , #{birth}
            , #{birthKnowYn}
            , #{gender}
            , #{neutrificationYn}
            , #{speciesType}
            , #{breedType}
            , IFNULL(#{breed}, (SELECT kor_name FROM PN_CODE WHERE code_group1 = 'BREED_TYPE' AND code_group2 = #{speciesType} AND code = #{breedType}))
            , #{remark}
            , 'Y'
            , #{bodyLength}
            , (
                  SELECT main_yn
                  FROM (
                           SELECT
                               CASE WHEN COUNT(pet_no) > 0 THEN 'N' ELSE 'Y' END AS main_yn
                           FROM PN_PET
                           WHERE use_yn = 'Y'
                             AND user_id = #{userId}
                       ) AS t
                  )
            , #{petInfo}
            , now()
            , now()
        )
    </insert>

    <update id="updatePet" parameterType="com.petnote.api.pet.dto.PetDTO">
        /* PetMapper.updatePet 펫정보 수정 */
        UPDATE PN_PET SET
            pet_name = #{petName}
            , birth = #{birth}
            , birth_know_yn = #{birthKnowYn}
            , gender = #{gender}
            , neutrification_yn = #{neutrificationYn}
            , species_type = #{speciesType}
            , breed_type = #{breedType}
            , breed = (IFNULL(#{breed}, (SELECT kor_name FROM PN_CODE WHERE code_group1 = 'BREED_TYPE' AND code_group2 = #{speciesType} AND code = #{breedType})))
            , remark = #{remark}
            , body_length = #{bodyLength}
            , pet_info = #{petInfo}
            , update_date = NOW()
        WHERE user_id = #{userId} AND pet_no = #{petNo}
    </update>

    <insert id="insertImage" parameterType="java.util.Map">
        /* PetMapper.insertImage 이미지 저장 */
        INSERT INTO PN_PET_IMG (
            pet_no
            , main_yn
            , file_path
            , original_file_name
            , file_name
            , file_size
            , insert_date
            , update_date
        )
        VALUES (
            #{petNo}
            , #{mainYn}
            , #{file.filePath}
            , #{file.originFileName}
            , #{file.fileName}
            , #{file.fileSize}
            , NOW()
            , NOW()
        )
    </insert>

    <delete id="deleteImage" parameterType="int">
        /* PetMapper.deleteImage 기존 대표이미지 삭제 */
        DELETE FROM PN_PET_IMG
        WHERE pet_no = #{petNo} AND main_yn = 'Y'
    </delete>

    <update id="deletePet" parameterType="com.petnote.api.pet.dto.PetDTO">
        /* PetMapper.deletePet 펫 삭제 */
        UPDATE PN_PET SET use_yn = 'N'
        WHERE user_id = #{userId}
         AND pet_no = #{petNo}
    </update>

</mapper>